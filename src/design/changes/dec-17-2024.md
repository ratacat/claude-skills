# Changes - December 17, 2024

## Migration from Python to JavaScript
**Start**: 23:39 PST
**Finish**: 23:45 PST
**User Request**: Convert from Python to JavaScript, redesign architecture, create requirements
**Requirements**: @book-processor.md
**Turns**: 1

### What Changed
- Deleted all Python files from `tools/` directory (process_book.py, gemini.py, extractors.py, process_book_simple.py)
- Removed Python dependencies (requirements.txt)
- Created `package.json` with Node.js project structure
  - Set up as ESM module (type: "module")
  - Added dependencies: @google/generative-ai, epub2, pdf-parse, commander
  - Defined CLI entry point: src/cli.js
- Created comprehensive requirements document: `src/design/requirements/book-processor.md`
  - Preserved chapter → extract → plan → generate architecture
  - Added detailed terminology and definitions
  - Defined TypeScript types for data structures (ChapterInfo, ChapterExtract, SkillPlan, SkillMetadata)
  - Created D2 execution flow diagram
  - Documented all processing stages with timing estimates
  - Emphasized prompt engineering for quality (preserve actionable content, avoid fluff)

### Design Decisions
- Kept the 4-stage progressive pipeline from Python version (validated approach)
- Focus improvement efforts on prompt engineering rather than architecture changes
- Target skill length: 500-2000 lines
- Default concurrency: 5 parallel chapter processes
- Use Gemini Flash for extraction, Gemini Pro for synthesis
- Support EPUB, MOBI, PDF formats

## Chapter Extraction Prompt Design
**Start**: 23:54 PST
**Finish**: 00:08 PST
**User Request**: Design structured question-based prompt for chapter extraction with multi-angle coverage
**Requirements**: @book-processor.md
**Turns**: 2

### What Changed
- Created `src/prompts/extract-chapter.md` - comprehensive extraction prompt with 8 structured questions
- Created `src/types/extraction.js` - JSDoc type definitions matching extraction schema
- Designed extraction approach based on specific, constrained questions rather than free-form summarization

### Extraction Question Categories
1. **Top 3 Takeaways** - Forced prioritization with category tags (pragmatic/concept/warning)
2. **Terminology and Definitions** - Key terms with definitions and relevance context (max 5)
3. **Mental Models and Frameworks** - 0-1 mental model describing how to think about problems
4. **Rules and Principles** - "Do this, not that" with reasoning and importance levels (max 7)
5. **Procedures and Workflows** - Step-by-step processes with usage context (max 3)
6. **Warnings and Anti-patterns** - Mistakes to avoid with better approaches (max 5)
7. **Examples** - Best 1-3 code examples with takeaways (max 3)
8. **Context and Application** - When to apply, what problems solved, prerequisites

### Design Principles Applied
- **Specificity with Constraints**: Force prioritization (top 3, max N)
- **Multi-angle Coverage**: Forward (do), negative (avoid), conditional (when), meta (why)
- **Separation of Information Types**: Distinct questions for concepts vs procedures vs warnings
- **Actionability Focus**: Emphasize concrete rules, examples, and decision frameworks
- **Character Limits**: Hard limits on all text fields to enforce brevity
- **Structured Output**: Single JSON object with consistent schema

### Key Improvements Over Previous Approach
- Explicit questions replace vague "summarize this chapter" prompts
- Forced ranking surfaces most important content
- Multi-angle questions (what/when/why/why-not) provide comprehensive coverage
- Character limits prevent rambling
- Structured schema ensures consistency across chapters
- Emphasis on preserving specific examples and code snippets

## JavaScript Implementation
**Start**: 00:08 PST
**Finish**: 00:25 PST
**User Request**: Build complete JavaScript implementation of 5-stage pipeline
**Requirements**: @book-processor.md
**Turns**: 1

### What Changed
Created complete JavaScript implementation with 5-stage pipeline:

#### Core Infrastructure
- `src/llm/client.js` - Gemini API wrapper with JSON parsing
- `src/extractors/index.js` - Text extraction from EPUB/PDF/MOBI
- `src/types/extraction.js` - JSDoc type definitions for extraction schema

#### Pipeline Stages
1. **Chapter Identification** (`src/pipeline/identify-chapters.js`)
   - Analyzes full book text to find chapter boundaries
   - Returns array of {title, start_pos, end_pos}
   - Prompt: `src/prompts/identify-chapters.md`

2. **Chapter Extraction** (`src/pipeline/extract-chapters.js`)
   - Processes chapters in parallel (configurable concurrency, default 5)
   - Uses structured 8-question prompt for each chapter
   - Handles failures gracefully, continues with successful extracts
   - Prompt: `src/prompts/extract-chapter.md`

3. **Synthesis** (`src/pipeline/synthesize.js`)
   - Reviews all chapter extracts
   - Removes duplicates, identifies themes
   - Organizes by topic (not chapter order)
   - Connects cross-chapter concepts
   - Prompt: `src/prompts/synthesize.md`

4. **Skill Generation** (`src/pipeline/generate-skill.js`)
   - Transforms synthesis into polished SKILL.md
   - Includes frontmatter, structured sections
   - Maintains actionability and specificity
   - Prompt: `src/prompts/generate-skill.md`

#### CLI
- `src/cli.js` - Command-line orchestrator using Commander
- Orchestrates all 5 stages
- Progress reporting for parallel processing
- Optional intermediate output saving
- Made executable with shebang

### Command-Line Usage
```bash
npm start sources/book.pdf \
  --skill-name "topic-expert" \
  --description "Expert knowledge on topic X. Use when working with X." \
  --concurrency 5 \
  --save-intermediates
```

### Architecture Decisions
- ESM modules (import/export)
- Async/await throughout
- Worker pool pattern for parallel chapter processing
- Graceful error handling (failed chapters don't block pipeline)
- Progress callbacks for user feedback
- Intermediate outputs optional (JSON extracts, markdown synthesis)

### File Structure
```
src/
├── cli.js                          # Main entry point
├── llm/
│   └── client.js                   # Gemini wrapper
├── extractors/
│   └── index.js                    # EPUB/PDF extraction
├── pipeline/
│   ├── identify-chapters.js        # Stage 1
│   ├── extract-chapters.js         # Stage 2
│   ├── synthesize.js               # Stage 3
│   └── generate-skill.js           # Stage 4
├── prompts/
│   ├── identify-chapters.md
│   ├── extract-chapter.md
│   ├── synthesize.md
│   └── generate-skill.md
└── types/
    └── extraction.js               # JSDoc types
```
